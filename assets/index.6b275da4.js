var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,u=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,o=(t,a,u)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:u}):t[a]=u,l=(e,t)=>{for(var a in t||(t={}))n.call(t,a)&&o(e,a,t[a]);if(u)for(var a of u(t))r.call(t,a)&&o(e,a,t[a]);return e};import{a as s,d as c}from"./vendor.3aa1c3d2.js";const i=Vue.createVNode("label",{for:"uploadWav"},"Select .wav file:",-1),g=Vue.createVNode("label",{for:"uploadTxt"},"Select .txt file:",-1);var d=Vue.defineComponent({expose:[],emits:["wav","txt"],setup(e,{emit:t}){const a=Vue.inject("getAudioContext"),u=e=>{var t;return(null==(t=null==e?void 0:e.files)?void 0:t.length)?e.files[0]:null},n=async e=>{const n=u(e.currentTarget);if(n){const e=a(),u=await n.arrayBuffer();t("wav",await e.decodeAudioData(u))}else t("wav",n)},r=async e=>{const a=u(e.currentTarget);t("txt",a?await a.text():"")};return(e,t)=>(Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[i,Vue.createVNode("input",{type:"file",onChange:n,accept:".wav",id:"uploadWav"},null,32),g,Vue.createVNode("input",{type:"file",onChange:r,accept:".txt",id:"uploadTxt"},null,32)],64))}}),p=Vue.defineComponent({expose:[],props:{audioBuffer:{type:Object},segments:{default:[]}},emits:["rendering"],setup(e,{emit:t}){const a=e,u=Vue.ref(),n=()=>{t("rendering",!0);const e=(()=>{if(!a.audioBuffer||!a.segments.length)return;const e=a.audioBuffer.sampleRate,t=a.segments.map((([t,a])=>[t*e|0,a*e|0])),u=t.reduce(((e,[t,a])=>e+a-t),0),n=new Float32Array(u);let r=0;t.forEach((([e,t])=>{const u=t-e;a.audioBuffer.copyFromChannel(n.subarray(r,r+u),0,e),r+=u}));const o=new AudioBuffer({sampleRate:e,length:u,numberOfChannels:1});o.copyToChannel(n,0);const l=new Uint8Array(s(o));let c="";for(r=0;r<l.byteLength;r++)c+=String.fromCharCode(l[r]);return"data:audio/wav;base64,"+btoa(c)})();t("rendering",!1),e&&u.value&&(u.value.href=e,u.value.click(),u.value.href="")};return(e,t)=>(Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode("button",{onClick:t[1]||(t[1]=e=>n())},"download"),Vue.withDirectives(Vue.createVNode("a",{ref:u,download:""},null,512),[[Vue.vShow,!1]])],64))}}),I=Vue.defineComponent({expose:[],props:{options:{type:Object,required:!0},segments:{default:[]}},emits:["peaks"],setup(e,{emit:t}){const a=e,{options:u,segments:n}=Vue.toRefs(a),r=Vue.ref(),o=Vue.ref(),s=Vue.ref(),c=Vue.ref();return Vue.watch([c,n],(()=>{c.value&&(c.value.segments.removeAll(),c.value.segments.add(n.value))})),Vue.watch(u,(async()=>{peaks.init(l({mediaElement:s.value,containers:{overview:r.value,zoomview:o.value}},u.value),((e,a)=>{if(e||!a)throw e;c.value=a,t("peaks",a)}))})),(e,t)=>(Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode("div",{class:"peaksOverview",ref:r},null,512),Vue.createVNode("div",{class:"peaksZoomview",ref:o},null,512),Vue.createVNode("audio",{class:"peaksAudio",ref:s},null,512)],64))}});I.__scopeId="data-v-471999b3";const V=Vue.createVNode("tr",null,"::::",-1);var C,m,v=Vue.defineComponent({expose:[],props:{annotatedTranscript:{default:[]}},setup:e=>(t,a)=>(Vue.openBlock(),Vue.createBlock("table",null,[(Vue.openBlock(!0),Vue.createBlock(Vue.Fragment,null,Vue.renderList(e.annotatedTranscript,(e=>(Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[V,(Vue.openBlock(!0),Vue.createBlock(Vue.Fragment,null,Vue.renderList(e,(e=>(Vue.openBlock(),Vue.createBlock("tr",null,[Vue.createVNode("td",null,Vue.toDisplayString(e.word),1),Vue.createVNode("td",null,Vue.toDisplayString(Vue.unref(c)(e.word)[0]),1),Vue.createVNode("td",null,Vue.toDisplayString(e.corpus),1),Vue.createVNode("td",null,Vue.toDisplayString(e.corpus&&Vue.unref(c)(e.corpus)[0]),1),Vue.createVNode("td",null,Vue.toDisplayString(e.start)+" - "+Vue.toDisplayString(e.end),1),Vue.createVNode("td",null,Vue.toDisplayString(e.conf),1)])))),256))],64)))),256))]))});function A(e,u){const n=Vue.computed((()=>e.value.split(/\s+/))),r=Vue.computed((()=>n.value.map(((e,t)=>{const[a,u]=c(e);return{primary:a,secondary:u,t:t}})))),o=Vue.computed((()=>r.value.flatMap((({primary:e,t:t})=>Array.from(e).map((e=>({phone:e,t:t}))))))),s=Vue.computed((()=>u.value.map(((e,t)=>e.map((({word:e},a)=>{const[u,n]=c(e);return{primary:u,secondary:n,s:t,w:a}}))))||[])),i=Vue.computed((()=>s.value.map((e=>e.flatMap((({primary:e,s:t,w:a})=>Array.from(e).map((e=>({phone:e,s:t,w:a}))))))))),g=Vue.ref(1),d=Vue.ref(-1),p=Vue.ref(-1),I=Vue.ref(-1),V=Vue.computed((()=>i.value.map((e=>{let t=Array.from(Array(o.value.length+1),(()=>Array(e.length+1).fill(0))),a=Array.from(Array(o.value.length+1),(()=>Array(e.length+1).fill(0)));for(let o=1;o<e.length+1;++o)t[0][o]=o*p.value;for(let s=1;s<o.value.length+1;++s)for(let u=1;u<e.length+1;++u){const n=o.value[s-1].phone===e[u-1].phone?g:d,r=t[s-1][u-1]+n.value,l=t[s-1][u]+I.value,c=t[s][u-1]+p.value,i=Math.max(r,l,c);t[s][u]=i;let V=0;i===r&&(V|=4),i===l&&(V|=1),i===c&&(V|=2),a[s][u]=V}const u=t[0].length-1;let n,r=[],l=[[{i:t.reduce(((e,t,a,n)=>t[u]>=n[e][u]?a:e),0),j:a[0].length-1}]];for(;n=l.pop();){const{i:e,j:t}=n[n.length-1],u=a[e][t];4&u?(n.push({i:e-1,j:t-1}),l.push(n)):1&u?(n.push({i:e-1,j:t}),l.push(n)):2&u?(n.push({i:e,j:t-1}),l.push(n)):r.push(n.reverse())}return{scores:t,edges:a,traces:r}})))),C=Vue.computed((()=>V.value.map(((e,t)=>e.traces.map((e=>e.filter((({i:e,j:t})=>0!==e&&0!==t)).map((({i:e,j:a})=>({t:o.value[e-1].t,w:i.value[t][a-1].w,s:t}))).filter((({t:e,w:t},a,u)=>{var n,r;return e!==(null==(n=u[a-1])?void 0:n.t)||t!==(null==(r=u[a-1])?void 0:r.w)})))))))),m=Vue.ref(3),v=Vue.computed((()=>{let e=1/0;return C.value.reduceRight(((u,n,r)=>{var o;if(0===n.length)return u;let s=n[0].findIndex((({t:t})=>t>=e));return s<0&&(s=n[0].length),(null==(o=n[0][s-1])?void 0:o.w)>=m.value-1&&(u.push(n[0].slice(0,s).map((e=>{return u=l({},e),t(u,a({s:r}));var u}))),e=n[0][0].t),u}),[]).reverse()})),A=Vue.computed((()=>v.value.map((e=>{const t=u.value[e[0].s];return[t[e[0].w].start,t[e[e.length-1].w].end]})))),f=Vue.computed((()=>{let e=u.value.map((e=>e.map((e=>l({},e)))));return v.value.forEach((t=>t.forEach((({t:t,s:a,w:u})=>e[a][u].corpus=n.value[t])))),e}));return{corpusTokens:n,corpusMetaphones:r,segmentMetaphones:s,phoneScores:V,phoneTraces:C,minWordCount:m,fullTrace:v,alignedSpans:A,annotatedTranscript:f}}(m=C||(C={}))[m.NONE=0]="NONE",m[m.INSERT=1]="INSERT",m[m.DELETE=2]="DELETE",m[m.MATCH=4]="MATCH";const f=e=>async function(e,t,a){try{return new AudioWorkletNode(e,t)}catch(u){return await e.audioWorklet.addModule(a),new AudioWorkletNode(e,t)}}(e,"vad-processor","data:application/javascript;base64,Ly8gdmFkLXByb2Nlc3Nvci5qcwpjbGFzcyBWYWRQcm9jZXNzb3IgZXh0ZW5kcyBBdWRpb1dvcmtsZXRQcm9jZXNzb3IgewogIHByZXY7IC8vIDogbnVtYmVyW11bXSB8IHVuZGVmaW5lZDsKICBob2xkOyAvLyA6IG51bWJlcltdW10gfCB1bmRlZmluZWQ7CiAgcHJvY2VzcygKICAgIGlucHV0cywgLy8gOiBGbG9hdDMyQXJyYXlbXVtdLAogICAgb3V0cHV0cyAvLyA6IEZsb2F0MzJBcnJheVtdW10KICApIHsKICAgIGNvbnN0IEkgPSBpbnB1dHM/Lmxlbmd0aCA/PyAwLAogICAgICBKID0gaW5wdXRzWzBdPy5sZW5ndGggPz8gMCwKICAgICAgSyA9IGlucHV0c1swXVswXT8ubGVuZ3RoID8/IDAsCiAgICAgIGlLID0gMSAvIEs7CiAgICBpZiAoIShJICYmIEogJiYgSykpIHJldHVybiB0cnVlOwogICAgaWYgKCF0aGlzLnByZXYpIHRoaXMucHJldiA9IEFycmF5KEkpLmZpbGwoQXJyYXkoSikuZmlsbCgwKSk7CiAgICBpZiAoIXRoaXMuaG9sZCkgdGhpcy5ob2xkID0gQXJyYXkoSSkuZmlsbChBcnJheShKKS5maWxsKDApKTsKICAgIGZvciAobGV0IGkgPSBJOyBpLS07ICkKICAgICAgZm9yIChsZXQgaiA9IEo7IGotLTsgKSB7CiAgICAgICAgbGV0IGRpZmYgPSAwLAogICAgICAgICAgbWF4ID0gMCwKICAgICAgICAgIHN1bSA9IDAsCiAgICAgICAgICB6cGMgPSAtMi41LCAvLyAiZXhwZWN0ZWQiIHpwYyBmb3Igdm9pY2UgcmFuZ2UKICAgICAgICAgIHNxID0gMDsKICAgICAgICBmb3IgKGxldCBwcmV2ID0gdGhpcy5wcmV2W2ldW2pdLCBrID0gSzsgay0tOyApIHsKICAgICAgICAgIGNvbnN0IHZhbCA9IGlucHV0c1tpXVtqXVtrXTsKICAgICAgICAgIG1heCA9IE1hdGgubWF4KG1heCwgdmFsLCAtdmFsKTsKICAgICAgICAgIHN1bSArPSBNYXRoLmFicyh2YWwpOwogICAgICAgICAgZGlmZiArPSBNYXRoLmFicyh2YWwgLSBwcmV2KTsKICAgICAgICAgIHNxICs9IHZhbCAqKiAyOwogICAgICAgICAgenBjIC09IE1hdGguc2lnbihwcmV2KSBeIE1hdGguc2lnbih2YWwpOwogICAgICAgICAgcHJldiA9IHZhbDsKICAgICAgICB9CiAgICAgICAgLy8gbm8gY2x1ZSB3aHkgYnV0IGl0IHdvcmtzCiAgICAgICAgbGV0IHZveCA9ICgyICogZGlmZikgLyB6cGMgKyB6cGMgLyAoNCAqIEspOwogICAgICAgIC8vIGJpYXMgdG93YXJkcyBhY3RpdmF0aW9uCiAgICAgICAgY29uc3QgaCA9IHRoaXMuaG9sZFtpXVtqXTsKICAgICAgICBjb25zdCBhID0gMC4wMDE7CiAgICAgICAgaWYgKHZveCA8IGgpIHZveCA9ICgxIC0gYSkgKiBoICsgYSAqIHZveDsKICAgICAgICBlbHNlIHZveCA9ICgxIC0gYSkgKiB2b3ggKyBhICogaDsKICAgICAgICB0aGlzLmhvbGRbaV1bal0gPSB2b3g7CiAgICAgICAgLy8gcmVzY2FsZSBvdXRwdXQKICAgICAgICB2b3ggPSAxIC0gTWF0aC5leHAoLXZveCAvIDIpOwogICAgICAgIHN1bSAvPSBLOwogICAgICAgIGlmIChzdW0gPCBpSykgdm94ID0gLXN1bTsKICAgICAgICBvdXRwdXRzW2ldW2pdLmZpbGwodm94ID4gMCA/IDEgOiAtMC41KTsKICAgICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQp9CgpyZWdpc3RlclByb2Nlc3NvcigidmFkLXByb2Nlc3NvciIsIFZhZFByb2Nlc3Nvcik7Cg==");async function h(e,t=1){const a=await async function(e){const t=new OfflineAudioContext({length:e.length,sampleRate:e.sampleRate,numberOfChannels:1}),a=t.createBiquadFilter();a.type="lowpass",a.frequency.value=3200;const u=t.createBiquadFilter();u.type="highpass",u.frequency.value=120;const n=await f(t),r=t.createBiquadFilter();r.type="lowpass",r.frequency.value=80;const o=t.createBufferSource();return o.buffer=e,o.connect(a).connect(u).connect(n).connect(r).connect(t.destination),o.start(),await t.startRendering()}(e);let u=[];const n=a.getChannelData(0),r=t*a.sampleRate|0;let o=0,l=0;for(let g=0;g<n.length;++g){n[g]>0&&l>o&&(l-o>=r&&u.push([o/a.sampleRate,l/a.sampleRate]),o=g+1),l=g}u=u.reduce(((e,[t,a])=>{if(!e.length)return[[t,a]];const[u,n]=e[e.length-1];return t-n<.1?e[e.length-1][1]=a:e.push([t,a]),e}),[]);let s=[];o=0;for(let[g,d]of u)s.push([o,g]),o=d;o<a.duration&&s.push([o,a.duration]);const c=t/2,i=e=>0<=e?e<a.duration?e:a.duration:0;return s=s.filter((([e,t])=>t!==e)).map((([e,t])=>[i(e-c),i(t+c)])),{silences:u,segments:s}}function y(e){const t=Vue.ref([]),a=Vue.ref(""),u=Vue.ref(""),n=Vue.ref(!1),r=async function(e="/vosk-model-small-en-us-0.15.tar.gz"){const t=await Vosk.createModel(e);return{terminate:t.terminate.bind(t),transcribe:async function*(e,a,u,n){a||(a=[[0,e.duration]]);let r,o=[],l=new Promise((e=>r=e));const s=()=>{r(),l=new Promise((e=>r=e))},c=new t.KaldiRecognizer(e.sampleRate,u);c.on("partialresult",(e=>{e.result&&n&&n(e.result.partial),s()})),c.on("result",(e=>{var t,a;(null==(a=null==(t=null==e?void 0:e.result)?void 0:t.result)?void 0:a.length)&&o.push(e.result),s()}));for(let[i,g]of a){i=Math.floor(i*e.sampleRate),g=Math.floor(g*e.sampleRate);const a=new Float32Array(g-i);e.copyFromChannel(a,0,i);for(let e=a.length;e--;)a[e]*=32768;t.postMessage({action:"audioChunk",data:a,recognizerId:c.id,sampleRate:e.sampleRate},{transfer:[a.buffer]}),await l,o.length&&(yield*o),o=[]}c.remove(),await l,o&&(yield*o)}}}(),o=async()=>{if(!e)return;if(t.value=[],a.value="",u.value="",!e.value)return;n.value=!0;let o=[],l=0,s=0;const{silences:c}=await h(e.value,.25);for(const[e,t]of c)s=(e+t)/2,l<s&&o.push([l,s]),l=s;s=e.value.duration,l<s&&o.push([l,s]);for await(const n of(await r).transcribe(e.value,o,void 0,(e=>u.value=e)))t.value.push(...n.result),Vue.triggerRef(t),n.text.length&&(a.value+=" "+n.text,Vue.triggerRef(a)),u.value="";n.value=!1};Vue.watch([e],o),o();const l=Vue.ref(2e3),s=Vue.computed((()=>{const a=l.value/1e3;let u=[],n=0;for(let e of t.value)n+a<=e.start&&u.push([n,e.start]),n=e.end;return u.push([n,e.value.duration]),u})),c=Vue.computed((()=>{if(0===t.value.length)return[];let e=0,a=[],u=[];for(const n of t.value){const t=s.value[e];if(n.end<=t[0])u.push(n);else for(u.length&&a.push(u),u=[n];n.end>s.value[++e][0];);}return u.length>0&&a.push(u),a}));return{transcription:t,text:a,partial:u,transcribing:n,minPause:l,segments:c,pauses:s}}const w=Vue.createTextVNode("Split at pause of length (ms):"),b=Vue.createTextVNode("Padding (ms):");var B=Vue.defineComponent({expose:[],setup(e){let t;const a=()=>(t||(t=new AudioContext),t);Vue.provide("getAudioContext",a);const u=Vue.ref(),n=Vue.ref(""),{minPause:r,segments:o}=y(u),l=A(n,o),s=Vue.ref(100),c=Vue.computed((()=>{var e;const t=s.value/1e3,a=(null==(e=u.value)?void 0:e.duration)||0;return l.alignedSpans.value.reduce(((e,[u,n],r,o)=>(u=Math.max(u-t,0),n=Math.min(n+t,a),0===r||o[r-1][1]<u?e.push([u,n]):e[e.length-1][1]=n,e)),[])})),i=Vue.ref(void 0),g=Vue.computed((()=>u.value?{keyboard:!0,webAudio:{audioContext:a(),audioBuffer:u.value}}:{})),V=Vue.computed((()=>o.value.map((e=>({startTime:e[0].start,endTime:e[e.length-1].end,labelText:e.map((({word:e})=>e)).join(" ")})))));return(e,t)=>(Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode("div",null,[w,Vue.withDirectives(Vue.createVNode("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>Vue.isRef(r)?r.value=e:null),type:"number"},null,512),[[Vue.vModelText,Vue.unref(r),void 0,{number:!0}]]),b,Vue.withDirectives(Vue.createVNode("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>s.value=e),type:"number"},null,512),[[Vue.vModelText,s.value,void 0,{number:!0}]])]),Vue.createVNode("div",null,[Vue.createVNode(d,{onWav:t[3]||(t[3]=e=>u.value=e),onTxt:t[4]||(t[4]=e=>n.value=e)}),Vue.createVNode(p,{"audio-buffer":u.value,segments:Vue.unref(c)},null,8,["audio-buffer","segments"])]),Vue.createVNode("div",null,[Vue.createVNode(I,{options:Vue.unref(g),onPeaks:t[5]||(t[5]=e=>i.value=e),segments:Vue.unref(V)},null,8,["options","segments"])]),Vue.createVNode("div",null,[Vue.createVNode(v,{"annotated-transcript":Vue.unref(l).annotatedTranscript.value},null,8,["annotated-transcript"])])],64))}});Vue.createApp(B).mount("#app");
