var e=Object.defineProperty,t=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,l=(t,a,u)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:u}):t[a]=u;import{G as r,g as n,a as o,d,l as s,W as i,R as c,$ as V,N as v,M as f,b as p,Z as m,y as g,H as h}from"./vendor.b6deefd6.js";const w=Vue.createVNode("i",{class:"el-icon-headset"},null,-1),y=Vue.createVNode("span",{class:"el-upload__text"},"Select audio file (.wav)",-1),N=Vue.createVNode("i",{class:"el-icon-notebook-2"},null,-1),x=Vue.createVNode("span",{class:"el-upload__text"},"Select script file (.txt)",-1);var b=Vue.defineComponent({expose:[],emits:["wav","txt"],setup(e,{emit:t}){const a=Vue.inject("getAudioContext"),u=async({raw:e})=>{if(e){const u=a(),l=await e.arrayBuffer();t("wav",await u.decodeAudioData(l))}else t("wav",e)},l=async({raw:e})=>{t("txt",e?await e.text():"")};return(e,t)=>(Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode(Vue.unref(r),{action:"","auto-upload":!1,onChange:u},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(n),{size:"small",type:"primary"},{default:Vue.withCtx((()=>[w,y])),_:1})])),_:1}),Vue.createVNode(Vue.unref(r),{action:"","auto-upload":!1,onChange:l},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(n),{size:"small",type:"primary"},{default:Vue.withCtx((()=>[N,x])),_:1})])),_:1})],64))}});const C=Vue.createTextVNode("download");var A,k,B=Vue.defineComponent({expose:[],props:{audioBuffer:{type:Object},segments:{default:[]}},emits:["rendering"],setup(e,{emit:t}){const a=e,u=Vue.ref(),l=()=>{t("rendering",!0);const e=(()=>{if(!a.audioBuffer||!a.segments.length)return;const e=a.audioBuffer.sampleRate,t=a.segments.map((([t,a])=>[t*e|0,a*e|0])),u=t.reduce(((e,[t,a])=>e+a-t),0),l=new Float32Array(u);let r=0;t.forEach((([e,t])=>{const u=t-e;a.audioBuffer.copyFromChannel(l.subarray(r,r+u),0,e),r+=u}));const n=new AudioBuffer({sampleRate:e,length:u,numberOfChannels:1});n.copyToChannel(l,0);const d=new Uint8Array(o(n));let s="";for(r=0;r<d.byteLength;r++)s+=String.fromCharCode(d[r]);return"data:audio/wav;base64,"+btoa(s)})();t("rendering",!1),e&&u.value&&(u.value.href=e,u.value.click(),u.value.href="")};return(e,t)=>(Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode(Vue.unref(n),{onClick:t[1]||(t[1]=e=>l())},{default:Vue.withCtx((()=>[C])),_:1}),Vue.withDirectives(Vue.createVNode("a",{ref:u,download:""},null,512),[[Vue.vShow,!1]])],64))}});function E(e,t,a=1,u=-1,l=-1,r=-1){return t.map((t=>function(e,t,a=1,u=-1,l=-1,r=-1){let n=Array.from(Array(e.length+1),(()=>Array(t.length+1).fill(0))),o=Array.from(Array(e.length+1),(()=>Array(t.length+1).fill(0)));for(let V=1;V<t.length+1;++V)n[0][V]=V*l;for(let V=1;V<e.length+1;++V)for(let d=1;d<t.length+1;++d){const s=e[V-1]===t[d-1]?a:u,i=n[V-1][d-1]+s,c=n[V-1][d]+r,v=n[V][d-1]+l,f=Math.max(i,c,v);n[V][d]=f;let p=0;f===i&&(p|=4),f===c&&(p|=1),f===v&&(p|=2),o[V][d]=p}const d=n[0].length-1;let s,i=[],c=[[{i:n.reduce(((e,t,a,u)=>t[d]>=u[e][d]?a:e),0),j:o[0].length-1}]];for(;s=c.pop();){const{i:e,j:t}=s[s.length-1],a=o[e][t];4&a?(s.push({i:e-1,j:t-1}),c.push(s)):1&a?(s.push({i:e-1,j:t}),c.push(s)):2&a?(s.push({i:e,j:t-1}),c.push(s)):i.push(s.reverse())}return{scores:n,edges:o,traces:i}}(e,t,a,u,l,r)))}function T(e,r){const n=Vue.computed((()=>e.value.split(/\s+/))),o=Vue.computed((()=>n.value.map(((e,t)=>{const[a,u]=d(e);return{primary:a,secondary:u,t:t}})))),i=Vue.computed((()=>o.value.flatMap((({primary:e,t:t})=>Array.from(e).map((e=>({phone:e,t:t}))))))),c=Vue.computed((()=>r.value.map(((e,t)=>e.map((({word:e},a)=>{const[u,l]=d(e);return{primary:u,secondary:l,s:t,w:a}}))))||[])),V=Vue.computed((()=>c.value.map((e=>e.flatMap((({primary:e,s:t,w:a})=>Array.from(e).map((e=>({phone:e,s:t,w:a}))))))))),v=Vue.ref(1),f=Vue.ref(-1),p=Vue.ref(-1),m=Vue.ref(-1),g=Vue.computed((()=>E(i.value.map((({phone:e})=>e)),V.value.map((e=>e.map((({phone:e})=>e)))),v.value,f.value,p.value,m.value))),h=Vue.ref(3),w=Vue.computed((()=>{var e;let t=[];if(!g.value.length)return t;let a=g.value[0].scores.length-1;if(a<=0)return t;for(let u=g.value.length;u--;){const{scores:l,edges:r}=g.value[u];let n=0;for(let e=l[0].length;--e;)l[a][n]<l[a][e]&&(n=e);let o=a,d=n,c=[];for(;o>1&&d>1;){const e=r[o][d];if(e&A.MATCH)o--,d--;else if(e&A.INSERT)o--;else{if(!(e&A.DELETE))throw"edge not found";d--}c.push([o,d])}const v=i.value[o-1].t;if(i.value[a-1].t-v>=h.value)for(c.map((([e,t])=>[i.value[e-1].t,V.value[u][t-1].w])).filter(((e,t,a)=>!s.exports.isEqual(e,a[t-1]))).forEach((([e,a])=>t.push({s:u,t:e,w:a})));(null==(e=i.value[a-1])?void 0:e.t)>=v;)a--;if(a<=0)break}return t.reverse()})),y=Vue.computed((()=>{let e=r.value.map((e=>e.map((e=>((e,r)=>{for(var n in r||(r={}))a.call(r,n)&&l(e,n,r[n]);if(t)for(var n of t(r))u.call(r,n)&&l(e,n,r[n]);return e})({},e)))));return w.value.forEach((({t:t,s:a,w:u})=>e[a][u].corpus=n.value[t])),e}));return{corpusTokens:n,corpusMetaphones:o,segmentMetaphones:c,phoneScores:g,matchReward:v,mismatchPenality:f,deletePenality:p,insertPenality:m,minWordCount:h,annotatedSegments:y,trace:w}}(k=A||(A={}))[k.NONE=0]="NONE",k[k.INSERT=1]="INSERT",k[k.DELETE=2]="DELETE",k[k.MATCH=4]="MATCH";function S(e){const t=Vue.ref([]),a=Vue.ref(""),u=Vue.ref(""),l=Vue.ref(!1),r=async function(e="/vorsovox/assets/vosk-model-small-en-us-0.15.tar.f0b24bb9.gz"){const t=await Vosk.createModel(e);let a=Promise.resolve();return async function*(e,u,l,r=65536){let n;await a,a=new Promise((e=>n=e));try{let a,o=[],d=new Promise((e=>a=e));const s=()=>{a(),d=new Promise((e=>a=e))},i=new t.KaldiRecognizer(e.sampleRate,u),c=e=>{(e=>{var t,a;return(null==(a=null==(t=e.result)?void 0:t.result)?void 0:a.length)>0})(e)?o.push(e.result):l&&(e=>{var t,a;return(null==(a=null==(t=e.result)?void 0:t.partial)?void 0:a.length)>0})(e)&&l(e.result.partial),s()};i.on("partialresult",c),i.on("result",c);for(let u=0;u<e.length;u+=r){let a=new Float32Array(r);e.copyFromChannel(a,0,u),e.length<u+r&&(a=a.subarray(0,e.length%r));for(let e=a.length;e--;)a[e]*=32768;t.postMessage({action:"audioChunk",data:a,recognizerId:i.id,sampleRate:e.sampleRate},{transfer:[a.buffer]}),await d,o.length&&(yield*o),o=[]}i.remove(),await d,o.length&&(yield*o)}finally{n()}}}();Vue.watch(e,(async()=>{const n=await r;if(t.value=[],a.value="",u.value="",e.value){l.value=!0;for await(const l of n(e.value,void 0,(e=>u.value=e)))t.value.push(...l.result),Vue.triggerRef(t),l.text.length&&(a.value+=" "+l.text,Vue.triggerRef(a)),u.value="";l.value=!1}}));const n=Vue.computed((()=>e.value?l.value?t.value.length?100*t.value[t.value.length-1].end/e.value.duration:0:100:0));return{transcription:t,text:a,partial:u,percentage:n,transcribing:l}}const R=Vue.createVNode("br",null,null,-1),_=Vue.createTextVNode("Silence between segments: "),M=Vue.createVNode("br",null,null,-1),D=Vue.createTextVNode("Padding around segments: "),j=Vue.createVNode("br",null,null,-1),F=Vue.createTextVNode("Minimum word count per segment: "),O=Vue.createVNode("br",null,null,-1),P=Vue.createTextVNode("From: "),I=Vue.createVNode("br",null,null,-1),U=Vue.createTextVNode("To: "),z=Vue.createVNode("br",null,null,-1),L={class:"active"};var W=Vue.defineComponent({expose:[],setup(e){const t="#00000022",a="#00000088",u=Vue.ref("files"),l=Vue.ref(""),r=Vue.ref(),{transcription:o,partial:d,transcribing:h,percentage:w}=S(r),y=Vue.ref(1),N=Vue.ref(.05),x=Vue.computed((()=>function(e,t=1){const a=[...e].sort(((e,t)=>{let a=e.start-t.start;return 0===a?e.end-t.end:a}));let u=[],l=[],r=0;for(const n of a)n.start<=r+t?l.push(n):(l.length&&u.push(l),l=[n]),r=n.end;return l.length>0&&u.push(l),u}(o.value,y.value))),C=T(l,x),A=Vue.ref(new Map),k=Vue.ref(new Map),E=Vue.ref({}),W=e=>{var t;if(e.id){const t=A.value.get(e.id);null==t||t.remove(),A.value.delete(e.id)}else null==(t=ee.value)||t.regions.add({id:(new Date).toString(),start:e.start,end:e.end,color:a})},H=e=>{if(e.id){const t=A.value.get(e.id);t&&t.update(e)}},q=e=>{var u,l;const r=E.value.id;if(r&&(null==(u=A.value.get(r))||u.update({id:r,color:t})),e){const t=A.value.get(e);if(t){const{start:u,end:n}=t;E.value={id:e,start:u,end:n},e!==r&&(null==(l=A.value.get(e))||l.update({id:e,color:a}))}}else E.value={}},G=e=>{E.value.id!==e.id&&(A.value.set(e.id,e),k.value.set(e.id,[e.start,e.end]),q(e.id))},K=e=>{A.value.set(e.id,e),k.value.set(e.id,[e.start,e.end]),Vue.triggerRef(A)},Z=e=>{A.value.delete(e.id),E.value.id===e.id&&(E.value={}),Vue.triggerRef(A)},$=e=>{const t=k.value.get(e.id);if(!t||t[0]===e.start&&t[1]===e.end||(J.value=!1),A.value.set(e.id,e),k.value.set(e.id,[e.start,e.end]),e.color===a){const{id:t,start:a,end:u}=e;E.value={id:t,start:a,end:u}}Vue.triggerRef(A)},J=Vue.ref(!0),Q=Vue.inject("getAudioContext"),X=Vue.ref(),Y=Vue.ref(),ee=Vue.ref();Vue.watchEffect((()=>{var e;if(!X.value||!r.value)return;null==(e=ee.value)||e.destroy();const t=i.create({audioContext:Q(),container:X.value,waveColor:"violet",progressColor:"purple",plugins:[{name:"regions",params:{},instance:c}]});t.on("region-created",K),t.on("region-updated",$),t.on("region-update-end",$),t.on("region-removed",Z),t.on("region-mouseenter",G),ee.value=t})),Vue.watchEffect((async()=>{ee.value&&r.value&&ee.value.loadDecodedBuffer(r.value)})),Vue.watch([ee,J,C.annotatedSegments,N],(()=>{if(!ee.value||!J.value||!r.value)return;ee.value.regions.clear(),A.value.clear();const e=e=>e<0?0:e<=r.value.duration?e:r.value.duration;for(const a of C.annotatedSegments.value){let u=0;for(let e=a.length;e--;)if(a[e].corpus){u=a[e].end;break}u>0&&ee.value.regions.add({id:u.toString(),start:e(a[0].start-N.value),end:e(u+N.value),color:t})}}));const te=Vue.computed((()=>{var e;let t=o.value.map((({word:e})=>({word:e,active:!1})));for(const{start:a,end:u,id:l}of A.value.values()){let r=s.exports.sortedIndexBy(o.value,{start:a},(({start:e})=>e)),n=o.value[r];for(;(null==n?void 0:n.end)<=u;)(e=t[r]).active||(e.active=E.value.start<n.end&&n.start<E.value.end),t[r].regionId=l,n=o.value[++r]}return t})),ae=Vue.computed((()=>[...A.value.values()].map((({start:e,end:t})=>[e,t]))));return(e,t)=>{const a=Vue.resolveDirective("loading");return Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode(Vue.unref(V),{modelValue:u.value,"onUpdate:modelValue":t[11]||(t[11]=e=>u.value=e)},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(v),{label:"Select Files",name:"files"},{default:Vue.withCtx((()=>[Vue.createVNode(b,{onWav:t[1]||(t[1]=e=>r.value=e),onTxt:t[2]||(t[2]=e=>l.value=e)})])),_:1}),Vue.createVNode(Vue.unref(v),{label:"Auto Align",name:"align"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(f),{modelValue:J.value,"onUpdate:modelValue":t[3]||(t[3]=e=>J.value=e),"active-text":"ON","inactive-text":"OFF"},null,8,["modelValue"]),R,_,Vue.createVNode(Vue.unref(p),{modelValue:y.value,"onUpdate:modelValue":t[4]||(t[4]=e=>y.value=e)},null,8,["modelValue"]),M,D,Vue.createVNode(Vue.unref(p),{modelValue:N.value,"onUpdate:modelValue":t[5]||(t[5]=e=>N.value=e)},null,8,["modelValue"]),j,F,Vue.createVNode(Vue.unref(p),{modelValue:Vue.unref(C).minWordCount.value,"onUpdate:modelValue":t[6]||(t[6]=e=>Vue.unref(C).minWordCount.value=e)},null,8,["modelValue"])])),_:1}),Vue.createVNode(Vue.unref(v),{label:"Manual Align",name:"edit",disabled:Vue.unref(h)||!r.value},{default:Vue.withCtx((()=>[O,P,Vue.createVNode(Vue.unref(p),{modelValue:E.value.start,"onUpdate:modelValue":t[7]||(t[7]=e=>E.value.start=e),onChange:t[8]||(t[8]=e=>H(E.value))},null,8,["modelValue"]),I,U,Vue.createVNode(Vue.unref(p),{modelValue:E.value.end,"onUpdate:modelValue":t[9]||(t[9]=e=>E.value.end=e),onChange:t[10]||(t[10]=e=>H(E.value))},null,8,["modelValue"]),z,Vue.createVNode(Vue.unref(n),{onClick:W,disabled:void 0===E.value.start||void 0===E.value.end},{default:Vue.withCtx((()=>[Vue.createTextVNode(Vue.toDisplayString(E.value.id?"Delete":"Add")+" Region",1)])),_:1},8,["disabled"])])),_:1},8,["disabled"]),Vue.createVNode(Vue.unref(v),{label:"Export",name:"export",disabled:Vue.unref(h)||!r.value},{default:Vue.withCtx((()=>[Vue.createVNode(B,{audioBuffer:r.value,segments:Vue.unref(ae)},null,8,["audioBuffer","segments"])])),_:1},8,["disabled"])])),_:1},8,["modelValue"]),Vue.withDirectives(Vue.createVNode(Vue.unref(m),{percentage:Vue.unref(w)},null,8,["percentage"]),[[Vue.vShow,Vue.unref(h)]]),Vue.withDirectives(Vue.createVNode(Vue.unref(g),{"element-loading-text":"Transcribing Audio..."},{default:Vue.withCtx((()=>[Vue.createVNode("div",{ref:X,style:{height:"200px"}},null,512),Vue.createVNode("audio",{ref:Y},null,512),(Vue.openBlock(!0),Vue.createBlock(Vue.Fragment,null,Vue.renderList(Vue.unref(te),(e=>(Vue.openBlock(),Vue.createBlock("span",{class:["word",Vue.unref(h)||e.regionId?"":"nonregion",e.active?"active":""],onClick:t=>q(e.regionId)},Vue.toDisplayString(e.word+" "),11,["onClick"])))),256)),Vue.createVNode("span",L,Vue.toDisplayString(Vue.unref(d)),1)])),_:1},512),[[a,Vue.unref(h)]])],64)}}}),H=Vue.defineComponent({expose:[],setup(e){let t;return Vue.provide("getAudioContext",(()=>(t||(t=new AudioContext),t))),(e,t)=>(Vue.openBlock(),Vue.createBlock(W))}});Vue.createApp(H).use(h).mount("#app");
