var e=Object.defineProperty,t=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,l=(t,u,a)=>u in t?e(t,u,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[u]=a;import{G as r,g as n,a as o,d,l as i,W as s,R as V,$ as c,N as v,M as f,b as p,Z as m,y as g,n as h,w,h as y,H as N}from"./vendor.5f5026b1.js";const x=Vue.createVNode("i",{class:"el-icon-headset"},null,-1),C=Vue.createVNode("span",{class:"el-upload__text"},"Select audio file (.wav)",-1),b=Vue.createVNode("i",{class:"el-icon-notebook-2"},null,-1),A=Vue.createVNode("span",{class:"el-upload__text"},"Select script file (.txt)",-1);var k=Vue.defineComponent({expose:[],emits:["wav","txt"],setup(e,{emit:t}){const u=Vue.inject("getAudioContext"),a=async({raw:e})=>{if(e){const a=u(),l=await e.arrayBuffer();t("wav",await a.decodeAudioData(l))}else t("wav",e)},l=async({raw:e})=>{t("txt",e?await e.text():"")};return(e,t)=>(Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode(Vue.unref(r),{action:"","auto-upload":!1,onChange:a},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(n),{size:"small",type:"primary"},{default:Vue.withCtx((()=>[x,C])),_:1})])),_:1}),Vue.createVNode(Vue.unref(r),{action:"","auto-upload":!1,onChange:l},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(n),{size:"small",type:"primary"},{default:Vue.withCtx((()=>[b,A])),_:1})])),_:1})],64))}});const T=Vue.createTextVNode("download");var B,E,S=Vue.defineComponent({expose:[],props:{audioBuffer:{type:Object},segments:{default:[]}},emits:["rendering"],setup(e,{emit:t}){const u=e,a=Vue.ref(),l=()=>{t("rendering",!0);const e=(()=>{if(!u.audioBuffer||!u.segments.length)return;const e=u.audioBuffer.sampleRate,t=u.segments.map((([t,u])=>[t*e|0,u*e|0])),a=t.reduce(((e,[t,u])=>e+u-t),0),l=new Float32Array(a);let r=0;t.forEach((([e,t])=>{const a=t-e;u.audioBuffer.copyFromChannel(l.subarray(r,r+a),0,e),r+=a}));const n=new AudioBuffer({sampleRate:e,length:a,numberOfChannels:1});n.copyToChannel(l,0);const d=new Uint8Array(o(n));let i="";for(r=0;r<d.byteLength;r++)i+=String.fromCharCode(d[r]);return"data:audio/wav;base64,"+btoa(i)})();t("rendering",!1),e&&a.value&&(a.value.href=e,a.value.click(),a.value.href="")};return(e,t)=>(Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode(Vue.unref(n),{onClick:t[1]||(t[1]=e=>l())},{default:Vue.withCtx((()=>[T])),_:1}),Vue.withDirectives(Vue.createVNode("a",{ref:a,download:""},null,512),[[Vue.vShow,!1]])],64))}});function R(e,t,u=1,a=-1,l=-1,r=-1){return t.map((t=>function(e,t,u=1,a=-1,l=-1,r=-1){let n=Array.from(Array(e.length+1),(()=>Array(t.length+1).fill(0))),o=Array.from(Array(e.length+1),(()=>Array(t.length+1).fill(0)));for(let c=1;c<t.length+1;++c)n[0][c]=c*l;for(let c=1;c<e.length+1;++c)for(let d=1;d<t.length+1;++d){const i=e[c-1]===t[d-1]?u:a,s=n[c-1][d-1]+i,V=n[c-1][d]+r,v=n[c][d-1]+l,f=Math.max(s,V,v);n[c][d]=f;let p=0;f===s&&(p|=4),f===V&&(p|=1),f===v&&(p|=2),o[c][d]=p}const d=n[0].length-1;let i,s=[],V=[[{i:n.reduce(((e,t,u,a)=>t[d]>=a[e][d]?u:e),0),j:o[0].length-1}]];for(;i=V.pop();){const{i:e,j:t}=i[i.length-1],u=o[e][t];4&u?(i.push({i:e-1,j:t-1}),V.push(i)):1&u?(i.push({i:e-1,j:t}),V.push(i)):2&u?(i.push({i:e,j:t-1}),V.push(i)):s.push(i.reverse())}return{scores:n,edges:o,traces:s}}(e,t,u,a,l,r)))}function _(e,r){const n=Vue.computed((()=>e.value.split(/\s+/))),o=Vue.computed((()=>n.value.map(((e,t)=>{const[u,a]=d(e);return{primary:u,secondary:a,t:t}})))),s=Vue.computed((()=>o.value.flatMap((({primary:e,t:t})=>Array.from(e).map((e=>({phone:e,t:t}))))))),V=Vue.computed((()=>r.value.map(((e,t)=>e.map((({word:e},u)=>{const[a,l]=d(e);return{primary:a,secondary:l,s:t,w:u}}))))||[])),c=Vue.computed((()=>V.value.map((e=>e.flatMap((({primary:e,s:t,w:u})=>Array.from(e).map((e=>({phone:e,s:t,w:u}))))))))),v=Vue.ref(1),f=Vue.ref(-1),p=Vue.ref(-1),m=Vue.ref(-1),g=Vue.computed((()=>R(s.value.map((({phone:e})=>e)),c.value.map((e=>e.map((({phone:e})=>e)))),v.value,f.value,p.value,m.value))),h=Vue.ref(3),w=Vue.computed((()=>{var e;let t=[];if(!g.value.length)return t;let u=g.value[0].scores.length-1;if(u<=0)return t;for(let a=g.value.length;a--;){const{scores:l,edges:r}=g.value[a];let n=0;for(let e=l[0].length;--e;)l[u][n]<l[u][e]&&(n=e);let o=u,d=n,V=[];for(;o>1&&d>1;){const e=r[o][d];if(e&B.MATCH)o--,d--;else if(e&B.INSERT)o--;else{if(!(e&B.DELETE))throw"edge not found";d--}V.push([o,d])}const v=s.value[o-1].t;if(s.value[u-1].t-v>=h.value)for(V.map((([e,t])=>[s.value[e-1].t,c.value[a][t-1].w])).filter(((e,t,u)=>!i.exports.isEqual(e,u[t-1]))).forEach((([e,u])=>t.push({s:a,t:e,w:u})));(null==(e=s.value[u-1])?void 0:e.t)>=v;)u--;if(u<=0)break}return t.reverse()})),y=Vue.computed((()=>{let e=r.value.map((e=>e.map((e=>((e,r)=>{for(var n in r||(r={}))u.call(r,n)&&l(e,n,r[n]);if(t)for(var n of t(r))a.call(r,n)&&l(e,n,r[n]);return e})({},e)))));return w.value.forEach((({t:t,s:u,w:a})=>e[u][a].corpus=n.value[t])),e}));return{corpusTokens:n,corpusMetaphones:o,segmentMetaphones:V,phoneScores:g,matchReward:v,mismatchPenality:f,deletePenality:p,insertPenality:m,minWordCount:h,annotatedSegments:y,trace:w}}(E=B||(B={}))[E.NONE=0]="NONE",E[E.INSERT=1]="INSERT",E[E.DELETE=2]="DELETE",E[E.MATCH=4]="MATCH";function D(e){const t=Vue.ref([]),u=Vue.ref(""),a=Vue.ref(""),l=Vue.ref(!1),r=async function(e="/vorsovox/assets/vosk-model-small-en-us-0.15.tar.f0b24bb9.gz"){const t=await Vosk.createModel(e);let u=Promise.resolve();return async function*(e,a,l,r=65536){let n;await u,u=new Promise((e=>n=e));try{let u,o=[],d=new Promise((e=>u=e));const i=()=>{u(),d=new Promise((e=>u=e))},s=new t.KaldiRecognizer(e.sampleRate,a),V=e=>{(e=>{var t,u;return(null==(u=null==(t=e.result)?void 0:t.result)?void 0:u.length)>0})(e)?o.push(e.result):l&&(e=>{var t,u;return(null==(u=null==(t=e.result)?void 0:t.partial)?void 0:u.length)>0})(e)&&l(e.result.partial),i()};s.on("partialresult",V),s.on("result",V);for(let a=0;a<e.length;a+=r){let u=new Float32Array(r);e.copyFromChannel(u,0,a),e.length<a+r&&(u=u.subarray(0,e.length%r));for(let e=u.length;e--;)u[e]*=32768;t.postMessage({action:"audioChunk",data:u,recognizerId:s.id,sampleRate:e.sampleRate},{transfer:[u.buffer]}),await d,o.length&&(yield*o),o=[]}s.remove(),await d,o.length&&(yield*o)}finally{n()}}}();Vue.watch(e,(async()=>{const n=await r;if(t.value=[],u.value="",a.value="",e.value){l.value=!0;for await(const l of n(e.value,void 0,(e=>a.value=e)))t.value.push(...l.result),Vue.triggerRef(t),l.text.length&&(u.value+=" "+l.text,Vue.triggerRef(u)),a.value="";l.value=!1}}));const n=Vue.computed((()=>e.value?l.value?t.value.length?100*t.value[t.value.length-1].end/e.value.duration:0:100:0));return{transcription:t,text:u,partial:a,percentage:n,transcribing:l}}const M=Vue.createVNode("br",null,null,-1),j=Vue.createTextVNode("Silence between segments: "),F=Vue.createVNode("br",null,null,-1),O=Vue.createTextVNode("Padding around segments: "),P=Vue.createVNode("br",null,null,-1),I=Vue.createTextVNode("Minimum word count per segment: "),U=Vue.createVNode("br",null,null,-1),z=Vue.createTextVNode("From: "),L=Vue.createVNode("br",null,null,-1),W=Vue.createTextVNode("To: "),H=Vue.createVNode("br",null,null,-1),q={class:"active nonregion"};var G=Vue.defineComponent({expose:[],setup(e){const t="#00000022",u="#00000088",a=Vue.ref(0),l=Vue.ref("files"),r=Vue.ref(""),o=Vue.ref(),{transcription:d,partial:N,transcribing:x,percentage:C}=D(o),b=Vue.ref(1),A=Vue.ref(.05),T=Vue.computed((()=>function(e,t=1){const u=[...e].sort(((e,t)=>{let u=e.start-t.start;return 0===u?e.end-t.end:u}));let a=[],l=[],r=0;for(const n of u)n.start<=r+t?l.push(n):(l.length&&a.push(l),l=[n]),r=n.end;return l.length>0&&a.push(l),a}(d.value,b.value))),B=_(r,T),E=Vue.ref(new Map),R=Vue.ref(new Map),G=Vue.ref({}),K=()=>{var e;const t=G.value;if(t.id){const e=E.value.get(t.id);null==e||e.remove(),E.value.delete(t.id)}else null==(e=le.value)||e.regions.add({id:(new Date).getTime().toString(),start:t.start,end:t.end,color:u})},Z=e=>{if(e.id){const t=E.value.get(e.id);t&&t.update(e)}},$=e=>{var a,l;const r=G.value.id;if(r&&(null==(a=E.value.get(r))||a.update({id:r,color:t})),e){const t=E.value.get(e);if(t){const{start:a,end:n}=t;G.value={id:e,start:a,end:n},e!==r&&(null==(l=E.value.get(e))||l.update({id:e,color:u}))}}else G.value={}},J=e=>{G.value.id!==e.id&&(E.value.set(e.id,e),R.value.set(e.id,[e.start,e.end]),$(e.id))},Q=e=>{E.value.set(e.id,e),R.value.set(e.id,[e.start,e.end]),Vue.triggerRef(E)},X=e=>{E.value.delete(e.id),G.value.id===e.id&&(G.value={}),Vue.triggerRef(E)},Y=e=>{const t=R.value.get(e.id);if(!t||t[0]===e.start&&t[1]===e.end||(l.value="edit",ee.value=!1),E.value.set(e.id,e),R.value.set(e.id,[e.start,e.end]),e.color===u){const{id:t,start:u,end:a}=e;G.value={id:t,start:u,end:a}}Vue.triggerRef(E)},ee=Vue.ref(!0),te=Vue.inject("getAudioContext"),ue=Vue.ref(),ae=Vue.ref(),le=Vue.ref();Vue.watchEffect((()=>{var e;if(!ue.value||!o.value)return;null==(e=le.value)||e.destroy();const t=s.create({audioContext:te(),container:ue.value,partialRender:!0,plugins:[{name:"regions",params:{},instance:V}]});t.on("region-created",Q),t.on("region-updated",Y),t.on("region-update-end",Y),t.on("region-removed",X),t.on("region-mouseenter",J),t.on("region-dblclick",(e=>setTimeout((()=>t.play(e.start,e.end)),0))),le.value=t})),Vue.watchEffect((async()=>{le.value&&o.value&&le.value.loadDecodedBuffer(o.value)})),Vue.watch([le,ee,B.annotatedSegments,A],(()=>{if(!le.value||!ee.value||!o.value)return;le.value.regions.clear(),E.value.clear();const e=e=>e<0?0:e<=o.value.duration?e:o.value.duration;for(const u of B.annotatedSegments.value){let a=0;for(let e=u.length;e--;)if(u[e].corpus){a=u[e].end;break}a>0&&le.value.regions.add({id:a.toString(),start:e(u[0].start-A.value),end:e(a+A.value),color:t})}}));const re=Vue.computed((()=>{var e;let t=d.value.map((({word:e})=>({word:e,active:!1})));for(const{start:u,end:a,id:l}of E.value.values()){let r=i.exports.sortedIndexBy(d.value,{start:u},(({start:e})=>e)),n=d.value[r];for(;(null==n?void 0:n.end)<=a;)(e=t[r]).active||(e.active=G.value.start<n.end&&n.start<G.value.end),t[r].regionId=l,n=d.value[++r]}return t})),ne=Vue.computed((()=>[...E.value.values()].map((({start:e,end:t})=>[e,t])))),oe=()=>{var e;return null==(e=le.value)?void 0:e.zoom(a.value**3/2048-a.value**2/16+4*a.value+1)};return(e,t)=>{const u=Vue.resolveDirective("loading");return Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode(Vue.unref(c),{modelValue:l.value,"onUpdate:modelValue":t[11]||(t[11]=e=>l.value=e)},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(v),{label:"Select Files",name:"files"},{default:Vue.withCtx((()=>[Vue.createVNode(k,{onWav:t[1]||(t[1]=e=>o.value=e),onTxt:t[2]||(t[2]=e=>r.value=e)})])),_:1}),Vue.createVNode(Vue.unref(v),{label:"Auto Align",name:"align"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(f),{modelValue:ee.value,"onUpdate:modelValue":t[3]||(t[3]=e=>ee.value=e),"active-text":"ON","inactive-text":"OFF"},null,8,["modelValue"]),M,j,Vue.createVNode(Vue.unref(p),{modelValue:b.value,"onUpdate:modelValue":t[4]||(t[4]=e=>b.value=e)},null,8,["modelValue"]),F,O,Vue.createVNode(Vue.unref(p),{modelValue:A.value,"onUpdate:modelValue":t[5]||(t[5]=e=>A.value=e)},null,8,["modelValue"]),P,I,Vue.createVNode(Vue.unref(p),{modelValue:Vue.unref(B).minWordCount.value,"onUpdate:modelValue":t[6]||(t[6]=e=>Vue.unref(B).minWordCount.value=e)},null,8,["modelValue"])])),_:1}),Vue.createVNode(Vue.unref(v),{label:"Manual Align",name:"edit",disabled:Vue.unref(x)||!o.value},{default:Vue.withCtx((()=>[U,z,Vue.createVNode(Vue.unref(p),{modelValue:G.value.start,"onUpdate:modelValue":t[7]||(t[7]=e=>G.value.start=e),onChange:t[8]||(t[8]=e=>Z(G.value))},null,8,["modelValue"]),L,W,Vue.createVNode(Vue.unref(p),{modelValue:G.value.end,"onUpdate:modelValue":t[9]||(t[9]=e=>G.value.end=e),onChange:t[10]||(t[10]=e=>Z(G.value))},null,8,["modelValue"]),H,Vue.createVNode(Vue.unref(n),{onClick:K},{default:Vue.withCtx((()=>[Vue.createTextVNode(Vue.toDisplayString(G.value.id?"Delete":"Add")+" Region",1)])),_:1})])),_:1},8,["disabled"]),Vue.createVNode(Vue.unref(v),{label:"Export",name:"export",disabled:Vue.unref(x)||!o.value},{default:Vue.withCtx((()=>[Vue.createVNode(S,{audioBuffer:o.value,segments:Vue.unref(ne)},null,8,["audioBuffer","segments"])])),_:1},8,["disabled"])])),_:1},8,["modelValue"]),Vue.withDirectives(Vue.createVNode(Vue.unref(m),{percentage:Vue.unref(C)},null,8,["percentage"]),[[Vue.vShow,Vue.unref(x)]]),Vue.createVNode(Vue.unref(g),null,{default:Vue.withCtx((()=>[Vue.withDirectives(Vue.createVNode(Vue.unref(h),{"element-loading-text":"Transcribing Audio..."},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(w),null,{default:Vue.withCtx((()=>[Vue.createVNode("div",{ref:ue},null,512)])),_:1})])),_:1},512),[[u,Vue.unref(x)]]),Vue.withDirectives(Vue.createVNode(Vue.unref(y),{modelValue:a.value,"onUpdate:modelValue":t[12]||(t[12]=e=>a.value=e),onChange:oe,"show-tooltip":!1},null,8,["modelValue"]),[[Vue.vShow,o.value]]),Vue.createVNode("audio",{ref:ae},null,512),(Vue.openBlock(!0),Vue.createBlock(Vue.Fragment,null,Vue.renderList(Vue.unref(re),(e=>(Vue.openBlock(),Vue.createBlock("span",{class:["word",e.regionId?"":"nonregion",e.active?"active":""],onClick:t=>$(e.regionId)},Vue.toDisplayString(e.word+" "),11,["onClick"])))),256)),Vue.createVNode("span",q,Vue.toDisplayString(Vue.unref(N)),1)])),_:1})],64)}}}),K=Vue.defineComponent({expose:[],setup(e){let t;return Vue.provide("getAudioContext",(()=>(t||(t=new AudioContext),t))),(e,t)=>(Vue.openBlock(),Vue.createBlock(G))}});Vue.createApp(K).use(N).mount("#app");
