var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,u=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,n=(t,a,u)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:u}):t[a]=u,o=(e,t)=>{for(var a in t||(t={}))r.call(t,a)&&n(e,a,t[a]);if(u)for(var a of u(t))l.call(t,a)&&n(e,a,t[a]);return e};import{G as d,g as s,a as i,d as c,W as V,R as v,l as f,$ as p,N as m,M as g,b as h,Z as w,y,H as x}from"./vendor.b6deefd6.js";const N=Vue.createVNode("i",{class:"el-icon-headset"},null,-1),b=Vue.createVNode("span",{class:"el-upload__text"},"Select audio file (.wav)",-1),C=Vue.createVNode("i",{class:"el-icon-notebook-2"},null,-1),A=Vue.createVNode("span",{class:"el-upload__text"},"Select script file (.txt)",-1);var k=Vue.defineComponent({expose:[],emits:["wav","txt"],setup(e,{emit:t}){const a=Vue.inject("getAudioContext"),u=async({raw:e})=>{if(e){const u=a(),r=await e.arrayBuffer();t("wav",await u.decodeAudioData(r))}else t("wav",e)},r=async({raw:e})=>{t("txt",e?await e.text():"")};return(e,t)=>(Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode(Vue.unref(d),{action:"","auto-upload":!1,onChange:u},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(s),{size:"small",type:"primary"},{default:Vue.withCtx((()=>[N,b])),_:1})])),_:1}),Vue.createVNode(Vue.unref(d),{action:"","auto-upload":!1,onChange:r},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(s),{size:"small",type:"primary"},{default:Vue.withCtx((()=>[C,A])),_:1})])),_:1})],64))}});const B=Vue.createTextVNode("download");var S,T,j=Vue.defineComponent({expose:[],props:{audioBuffer:{type:Object},segments:{default:[]}},emits:["rendering"],setup(e,{emit:t}){const a=e,u=Vue.ref(),r=()=>{t("rendering",!0);const e=(()=>{if(!a.audioBuffer||!a.segments.length)return;const e=a.audioBuffer.sampleRate,t=a.segments.map((([t,a])=>[t*e|0,a*e|0])),u=t.reduce(((e,[t,a])=>e+a-t),0),r=new Float32Array(u);let l=0;t.forEach((([e,t])=>{const u=t-e;a.audioBuffer.copyFromChannel(r.subarray(l,l+u),0,e),l+=u}));const n=new AudioBuffer({sampleRate:e,length:u,numberOfChannels:1});n.copyToChannel(r,0);const o=new Uint8Array(i(n));let d="";for(l=0;l<o.byteLength;l++)d+=String.fromCharCode(o[l]);return"data:audio/wav;base64,"+btoa(d)})();t("rendering",!1),e&&u.value&&(u.value.href=e,u.value.click(),u.value.href="")};return(e,t)=>(Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode(Vue.unref(s),{onClick:t[1]||(t[1]=e=>r())},{default:Vue.withCtx((()=>[B])),_:1}),Vue.withDirectives(Vue.createVNode("a",{ref:u,download:""},null,512),[[Vue.vShow,!1]])],64))}});function E(e,t,a=1,u=-1,r=-1,l=-1){return t.map((t=>function(e,t,a=1,u=-1,r=-1,l=-1){let n=Array.from(Array(e.length+1),(()=>Array(t.length+1).fill(0))),o=Array.from(Array(e.length+1),(()=>Array(t.length+1).fill(0)));for(let V=1;V<t.length+1;++V)n[0][V]=V*r;for(let V=1;V<e.length+1;++V)for(let d=1;d<t.length+1;++d){const s=e[V-1]===t[d-1]?a:u,i=n[V-1][d-1]+s,c=n[V-1][d]+l,v=n[V][d-1]+r,f=Math.max(i,c,v);n[V][d]=f;let p=0;f===i&&(p|=4),f===c&&(p|=1),f===v&&(p|=2),o[V][d]=p}const d=n[0].length-1;let s,i=[],c=[[{i:n.reduce(((e,t,a,u)=>t[d]>=u[e][d]?a:e),0),j:o[0].length-1}]];for(;s=c.pop();){const{i:e,j:t}=s[s.length-1],a=o[e][t];4&a?(s.push({i:e-1,j:t-1}),c.push(s)):1&a?(s.push({i:e-1,j:t}),c.push(s)):2&a?(s.push({i:e,j:t-1}),c.push(s)):i.push(s.reverse())}return{scores:n,edges:o,traces:i}}(e,t,a,u,r,l)))}function R(e,u){const r=Vue.computed((()=>e.value.split(/\s+/))),l=Vue.computed((()=>r.value.map(((e,t)=>{const[a,u]=c(e);return{primary:a,secondary:u,t:t}})))),n=Vue.computed((()=>l.value.flatMap((({primary:e,t:t})=>Array.from(e).map((e=>({phone:e,t:t}))))))),d=Vue.computed((()=>u.value.map(((e,t)=>e.map((({word:e},a)=>{const[u,r]=c(e);return{primary:u,secondary:r,s:t,w:a}}))))||[])),s=Vue.computed((()=>d.value.map((e=>e.flatMap((({primary:e,s:t,w:a})=>Array.from(e).map((e=>({phone:e,s:t,w:a}))))))))),i=Vue.ref(1),V=Vue.ref(-1),v=Vue.ref(-1),f=Vue.ref(-1),p=Vue.computed((()=>E(n.value.map((({phone:e})=>e)),s.value.map((e=>e.map((({phone:e})=>e)))),i.value,V.value,v.value,f.value))),m=Vue.computed((()=>p.value.map(((e,t)=>e.traces.map((e=>e.filter((({i:e,j:t})=>0!==e&&0!==t)).map((({i:e,j:a})=>({s:t,t:n.value[e-1].t,w:s.value[t][a-1].w}))).filter((({s:e,t:t,w:a},u,r)=>0===u||e!==r[u-1].s||t!==r[u-1].t||a!==r[u-1].w)))))))),g=Vue.ref(3),h=Vue.computed((()=>{let e=1/0;return m.value.reduceRight(((u,r,l)=>{var n;if(0===r.length)return u;let d=r[0].findIndex((({t:t})=>t>=e));return d<0&&(d=r[0].length),(null==(n=r[0][d-1])?void 0:n.w)>=g.value-1&&(u.push(r[0].slice(0,d).map((e=>{return u=o({},e),t(u,a({s:l}));var u}))),e=r[0][0].t),u}),[]).reverse()})),w=Vue.computed((()=>{let e=u.value.map((e=>e.map((e=>o({},e)))));return h.value.forEach((t=>t.forEach((({t:t,s:a,w:u})=>e[a][u].corpus=r.value[t])))),e}));return{corpusTokens:r,corpusMetaphones:l,segmentMetaphones:d,phoneScores:p,phoneTraces:m,minWordCount:g,fullTrace:h,annotatedSegments:w}}(T=S||(S={}))[T.NONE=0]="NONE",T[T.INSERT=1]="INSERT",T[T.DELETE=2]="DELETE",T[T.MATCH=4]="MATCH";function _(e){const t=Vue.ref([]),a=Vue.ref(""),u=Vue.ref(""),r=Vue.ref(!1),l=async function(e="/vorsovox/assets/vosk-model-small-en-us-0.15.tar.f0b24bb9.gz"){const t=await Vosk.createModel(e);let a=Promise.resolve();return async function*(e,u,r,l=65536){let n;await a,a=new Promise((e=>n=e));try{let a,o=[],d=new Promise((e=>a=e));const s=()=>{a(),d=new Promise((e=>a=e))},i=new t.KaldiRecognizer(e.sampleRate,u),c=e=>{(e=>{var t,a;return(null==(a=null==(t=e.result)?void 0:t.result)?void 0:a.length)>0})(e)?o.push(e.result):r&&(e=>{var t,a;return(null==(a=null==(t=e.result)?void 0:t.partial)?void 0:a.length)>0})(e)&&r(e.result.partial),s()};i.on("partialresult",c),i.on("result",c);for(let u=0;u<e.length;u+=l){let a=new Float32Array(l);e.copyFromChannel(a,0,u),e.length<u+l&&(a=a.subarray(0,e.length%l));for(let e=a.length;e--;)a[e]*=32768;t.postMessage({action:"audioChunk",data:a,recognizerId:i.id,sampleRate:e.sampleRate},{transfer:[a.buffer]}),await d,o.length&&(yield*o),o=[]}i.remove(),await d,o.length&&(yield*o)}finally{n()}}}();return Vue.watch(e,(async()=>{const n=await l;if(t.value=[],a.value="",u.value="",e.value){r.value=!0;for await(const r of n(e.value,void 0,(e=>u.value=e)))t.value.push(...r.result),Vue.triggerRef(t),r.text.length&&(a.value+=" "+r.text,Vue.triggerRef(a)),u.value="";r.value=!1}})),{transcription:t,text:a,partial:u,transcribing:r}}const O=Vue.createVNode("br",null,null,-1),D=Vue.createTextVNode("Silence between segments: "),M=Vue.createVNode("br",null,null,-1),F=Vue.createTextVNode("Padding around segments: "),P=Vue.createVNode("br",null,null,-1),I=Vue.createTextVNode("From: "),U=Vue.createVNode("br",null,null,-1),z=Vue.createTextVNode("To: "),L=Vue.createVNode("br",null,null,-1),H={class:"active"};var W=Vue.defineComponent({expose:[],setup(e){const t="#00000022",a="#00000088",u=Vue.ref("files"),r=Vue.ref(""),l=Vue.ref(),{transcription:n,partial:o,transcribing:d}=_(l),i=Vue.computed((()=>l.value?d.value?n.value.length?100*n.value[n.value.length-1].end/l.value.duration:0:100:0)),c=Vue.ref(1),x=Vue.ref(.05),N=Vue.computed((()=>function(e,t=1){const a=[...e].sort(((e,t)=>{let a=e.start-t.start;return 0===a?e.end-t.end:a}));let u=[],r=[],l=0;for(const n of a)n.start<=l+t?r.push(n):(r.length&&u.push(r),r=[n]),l=n.end;return r.length>0&&u.push(r),u}(n.value,c.value))),b=R(r,N),C=Vue.ref(new Map),A=Vue.ref(new Map),B=Vue.ref({}),S=e=>{var t;if(e.id){const t=C.value.get(e.id);null==t||t.remove(),C.value.delete(e.id)}else null==(t=X.value)||t.regions.add({id:(new Date).toString(),start:e.start,end:e.end,color:a})},T=e=>{if(e.id){const t=C.value.get(e.id);t&&t.update(e)}},E=e=>{var u,r;const l=B.value.id;if(l&&(null==(u=C.value.get(l))||u.update({id:l,color:t})),e){const t=C.value.get(e);if(t){const{start:u,end:n}=t;B.value={id:e,start:u,end:n},e!==l&&(null==(r=C.value.get(e))||r.update({id:e,color:a}))}}else B.value={}},W=e=>{B.value.id!==e.id&&(C.value.set(e.id,e),A.value.set(e.id,[e.start,e.end]),E(e.id))},G=e=>{C.value.set(e.id,e),A.value.set(e.id,[e.start,e.end]),Vue.triggerRef(C)},K=e=>{C.value.delete(e.id),B.value.id===e.id&&(B.value={}),Vue.triggerRef(C)},Z=e=>{const t=A.value.get(e.id);if(!t||t[0]===e.start&&t[1]===e.end||($.value=!1),C.value.set(e.id,e),A.value.set(e.id,[e.start,e.end]),e.color===a){const{id:t,start:a,end:u}=e;B.value={id:t,start:a,end:u}}Vue.triggerRef(C)},$=Vue.ref(!0),q=Vue.inject("getAudioContext"),J=Vue.ref(),Q=Vue.ref(),X=Vue.ref();Vue.watchEffect((()=>{var e;if(!J.value||!l.value)return;null==(e=X.value)||e.destroy();const t=V.create({audioContext:q(),container:J.value,waveColor:"violet",progressColor:"purple",plugins:[{name:"regions",params:{},instance:v}]});t.on("region-created",G),t.on("region-updated",Z),t.on("region-update-end",Z),t.on("region-removed",K),t.on("region-mouseenter",W),X.value=t})),Vue.watchEffect((async()=>{X.value&&l.value&&X.value.loadDecodedBuffer(l.value)})),Vue.watch([X,$,b.annotatedSegments,x],(()=>{if(!X.value||!$.value||!l.value)return;X.value.regions.clear(),C.value.clear();const e=e=>e<0?0:e<=l.value.duration?e:l.value.duration;for(const a of b.annotatedSegments.value){let u=0;for(let e=a.length;e--;)if(a[e].corpus){u=a[e].end;break}u>0&&X.value.regions.add({id:u.toString(),start:e(a[0].start-x.value),end:e(u+x.value),color:t})}}));const Y=Vue.computed((()=>{var e;let t=n.value.map((({word:e})=>({word:e,active:!1})));for(const{start:a,end:u,id:r}of C.value.values()){let l=f.exports.sortedIndexBy(n.value,{start:a},(({start:e})=>e)),o=n.value[l];for(;(null==o?void 0:o.end)<=u;)(e=t[l]).active||(e.active=B.value.start<o.end&&o.start<B.value.end),t[l].regionId=r,o=n.value[++l]}return t})),ee=Vue.computed((()=>[...C.value.values()].map((({start:e,end:t})=>[e,t]))));return(e,t)=>{const a=Vue.resolveDirective("loading");return Vue.openBlock(),Vue.createBlock(Vue.Fragment,null,[Vue.createVNode(Vue.unref(p),{modelValue:u.value,"onUpdate:modelValue":t[10]||(t[10]=e=>u.value=e)},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(m),{label:"Select Files",name:"files"},{default:Vue.withCtx((()=>[Vue.createVNode(k,{onWav:t[1]||(t[1]=e=>l.value=e),onTxt:t[2]||(t[2]=e=>r.value=e)})])),_:1}),Vue.createVNode(Vue.unref(m),{label:"Auto Align",name:"align"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(g),{modelValue:$.value,"onUpdate:modelValue":t[3]||(t[3]=e=>$.value=e),"active-text":"ON","inactive-text":"OFF"},null,8,["modelValue"]),O,D,Vue.createVNode(Vue.unref(h),{modelValue:c.value,"onUpdate:modelValue":t[4]||(t[4]=e=>c.value=e)},null,8,["modelValue"]),M,F,Vue.createVNode(Vue.unref(h),{modelValue:x.value,"onUpdate:modelValue":t[5]||(t[5]=e=>x.value=e)},null,8,["modelValue"])])),_:1}),Vue.createVNode(Vue.unref(m),{label:"Manual Align",name:"edit",disabled:Vue.unref(d)||!l.value},{default:Vue.withCtx((()=>[P,I,Vue.createVNode(Vue.unref(h),{modelValue:B.value.start,"onUpdate:modelValue":t[6]||(t[6]=e=>B.value.start=e),onChange:t[7]||(t[7]=e=>T(B.value))},null,8,["modelValue"]),U,z,Vue.createVNode(Vue.unref(h),{modelValue:B.value.end,"onUpdate:modelValue":t[8]||(t[8]=e=>B.value.end=e),onChange:t[9]||(t[9]=e=>T(B.value))},null,8,["modelValue"]),L,Vue.createVNode(Vue.unref(s),{onClick:S,disabled:void 0===B.value.start||void 0===B.value.end},{default:Vue.withCtx((()=>[Vue.createTextVNode(Vue.toDisplayString(B.value.id?"Delete":"Add")+" Region",1)])),_:1},8,["disabled"])])),_:1},8,["disabled"]),Vue.createVNode(Vue.unref(m),{label:"Export",name:"export",disabled:Vue.unref(d)||!l.value},{default:Vue.withCtx((()=>[Vue.createVNode(j,{audioBuffer:l.value,segments:Vue.unref(ee)},null,8,["audioBuffer","segments"])])),_:1},8,["disabled"])])),_:1},8,["modelValue"]),Vue.withDirectives(Vue.createVNode(Vue.unref(w),{percentage:Vue.unref(i)},null,8,["percentage"]),[[Vue.vShow,Vue.unref(d)]]),Vue.withDirectives(Vue.createVNode(Vue.unref(y),{"element-loading-text":"Transcribing Audio..."},{default:Vue.withCtx((()=>[Vue.createVNode("div",{ref:J,style:{height:"200px"}},null,512),Vue.createVNode("audio",{ref:Q},null,512),(Vue.openBlock(!0),Vue.createBlock(Vue.Fragment,null,Vue.renderList(Vue.unref(Y),(e=>(Vue.openBlock(),Vue.createBlock("span",{class:["word",Vue.unref(d)||e.regionId?"":"nonregion",e.active?"active":""],onClick:t=>E(e.regionId)},Vue.toDisplayString(e.word+" "),11,["onClick"])))),256)),Vue.createVNode("span",H,Vue.toDisplayString(Vue.unref(o)),1)])),_:1},512),[[a,Vue.unref(d)]])],64)}}}),G=Vue.defineComponent({expose:[],setup(e){let t;return Vue.provide("getAudioContext",(()=>(t||(t=new AudioContext),t))),(e,t)=>(Vue.openBlock(),Vue.createBlock(W))}});Vue.createApp(G).use(x).mount("#app");
